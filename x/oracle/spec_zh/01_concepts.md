<!--
预言机：1
-->

# 概念

## 投票程序

在每个“VotePeriod”期间，Oracle 模块通过要求验证器集的所有成员在间隔结束前提交对 Luna 汇率的投票，就 Luna 对“白名单”中指定的面额的汇率达成共识。

验证者必须首先预先承诺一个汇率，然后在随后的“VotePeriod”中提交并披露他们的汇率以及他们以该价格预先承诺的证明。该方案强制选民在知道其他人的投票之前提交提交，从而降低 Oracle 中的中心化和搭便车风险。

*预先投票和投票

    让`P_t` 是由`VotePeriod` 定义的当前持续时间间隔(当前设置为30 秒)，在此期间验证者必须提交两条消息：

    * 一个 `MsgAggregateExchangeRatePrevote`，包含 Luna 相对于 Terra 挂钩的汇率的 SHA256 哈希值。对于报告 Luna 汇率的所有不同面额，必须提交预投票。
    * 一个 `MsgAggregateExchangeRateVote`，包含用于为前一个间隔 `P_t-1` 中提交的聚合预投票创建散列的盐。

* 投票统计

    在“P_t”结束时，对提交的投票进行统计。

    每次投票提交的salt用于验证与验证者在“P_t-1”中提交的prevote的一致性。如果验证者未提交预投票，或者由盐生成的 SHA256 与预投票的哈希不匹配，则投票将被丢弃。

    对于每个面额，如果提交的投票的总投票权超过 50%，则投票的加权中位数在链上记录为 Luna 兑该面额的有效汇率，用于接下来的 `VotePeriod``P_t+1`。

    收到少于“VoteThreshold”总投票权的面额将其汇率从存储中删除，并且在下一个 VotePeriod“P_t+1”期间不能与它进行掉期。

* 投票奖励

    计票后，通过“tally()”确定选票的获胜者。

    成功在加权中位数附近的狭窄范围内投票的选民将获得一部分所收集的铸币税。有关更多详细信息，请参阅“k.RewardBallotWinners()”。

    > 从 Columbus-3 开始，[Market](../../market/spec/README.md) 交换的费用不再包含在 oracle 奖励池中，并在交换操作期间立即销毁。

## 奖励带

令`M` 为加权中位数，`𝜎` 为选票中选票的标准差，以及 RewardBand 参数。中位数周围的带设置为`𝜀 = max(𝜎, R/2)`。所有在区间`[M - 𝜀, M + 𝜀]` 内提交汇率投票的有效(即保税和未入狱)验证者都应包括在获胜者的集合中，并按其相对投票权进行加权。

## 削减

> 请务必仔细阅读本节，因为它涉及潜在的资金损失。

发生以下任一事件的 `VotePeriod` 被视为“未命中”：

* 验证者未能针对“白名单”中指定的**每种**面额提交对 Luna 汇率的投票。

* 验证者未能在围绕一种或多种面额的加权中位数的“奖励范围”内投票。

在每个 `SlashWindow` 期间，参与的验证者必须保持至少 `MinValidPerWindow` (5%) 的有效投票率，以免他们的股份被削减(目前设置为 0.01%)。被削减的验证人会被协议自动暂时“监禁”(以保护委托人的资金)，运营商应及时修复差异以恢复验证人参与。

## 弃权投票

验证者可以通过为 `MsgExchangeRateVote` 中的 `ExchangeRate` 字段提交一个非正整数来放弃投票。这样做将免除他们因错过“VotePeriod”而受到的任何处罚，但也会使他们失去因忠实报告而获得 Oracle 铸币税奖励的资格。

## 消息

> 计票、Luna 汇率更新、选票奖励和削减的控制流程发生在每个 `VotePeriod` 的末尾，并在 [end-block ABCI](./03_end_block.md) 函数中找到，而不是在里面消息处理程序。